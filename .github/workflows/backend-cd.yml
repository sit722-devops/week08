name: Backend CD - Deploy Backend Services to AKS

on:
  workflow_dispatch:

env:
  NS: ecommerce
  IMAGE_TAG: ${{ github.sha }}-${{ github.run_id }}

jobs:
  deploy_backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ secrets.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ secrets.AKS_CLUSTER_NAME }}

      - name: Update image references
        run: |
          sed -i "s#IMAGE_PRODUCT_PLACEHOLDER#${{ secrets.ACR_LOGIN_SERVER }}/product_service:${{ env.IMAGE_TAG }}#g" k8s/product-service.yaml
          sed -i "s#IMAGE_ORDER_PLACEHOLDER#${{ secrets.ACR_LOGIN_SERVER }}/order_service:${{ env.IMAGE_TAG }}#g" k8s/order-service.yaml

      - name: Deploy Config + Secrets + DBs
        run: |
          kubectl apply -n ecommerce -f k8s/secrets.yaml
          kubectl apply -n ecommerce -f k8s/configmaps.yaml
          kubectl apply -n ecommerce -f k8s/product-db.yaml
          kubectl apply -n ecommerce -f k8s/order-db.yaml

      - name: Deploy Backend Services
        run: |
          kubectl apply -n ecommerce -f k8s/product-service.yaml
          kubectl apply -n ecommerce -f k8s/order-service.yaml

      - name: Verify rollout
        run: |
          kubectl rollout status deploy/product-service-w08e1 -n ecommerce
          kubectl rollout status deploy/order-service-w08e1 -n ecommerce
