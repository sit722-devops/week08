name: Backend CI - Build & Push Images to ACR

on:
  workflow_dispatch:
  push:
    branches:
      - dev
    paths:
      - 'backend/**'
      - '.github/workflows/backend_ci.yml'

jobs:
  build_services:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        svc:
          - name: backend/product_service
            context: backend/product_service
            dockerfile: backend/product_service/Dockerfile
            image: product_service
          - name: backend/order_service
            context: backend/order_service
            dockerfile: backend/order_service/Dockerfile
            image: order_service

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build & push ${{ matrix.svc.name }}
        uses: ./.github/workflows/reusable-acr-build.yml
        with:
          context: ${{ matrix.svc.context }}
          dockerfile: ${{ matrix.svc.dockerfile }}
          image_name: ${{ matrix.svc.image }}
          tags: latest
        secrets: inherit
