# week08/.github/workflows/frontend-cd.yml
name: Frontend CD - Deploy to AKS

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Frontend image tag to deploy (defaults to current sha-runid)"
        required: false
      product_api_url:
        description: "Optional: override PRODUCT_API (e.g., http://X.X.X.X:8000). Leave blank to use cluster DNS."
        required: false
      order_api_url:
        description: "Optional: override ORDER_API (e.g., http://Y.Y.Y.Y:8001). Leave blank to use cluster DNS."
        required: false

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}     # e.g. akacrweek08.azurecr.io
  IMAGE_TAG:        ${{ github.event.inputs.image_tag || format('{0}-{1}', github.sha, github.run_id) }}
  NS: ecommerce

jobs:
  deploy_frontend:
    runs-on: ubuntu-latest
    # remove the next line unless you created an Environment named Production
    # environment: Production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ secrets.AKS_RESOURCE_GROUP }}
          cluster-name:  ${{ secrets.AKS_CLUSTER_NAME }}

      - name: Create namespace
        run: kubectl c
